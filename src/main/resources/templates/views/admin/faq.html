<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{views/admin/admin-layout :: layout(~{::head}, ~{::main})}">
<head>
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />	
    <link rel="stylesheet" href="/css/admin/faq.css">
</head>
<main>
    <div class="container">
        <h1>자주 묻는 질문 관리</h1>
        <div class="faq-buttons">
        	<button class="add-btn" id="first-add-btn">+</button>
        	<button class="cancel-btn" id="cancel-btn" style="display: none;">취소</button>
        </div>
        <div id="faq-list" class="faq-list">
            <!-- FAQ 항목들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        var faqData = /*[[${faqList}]]*/ [];
        /*]]>*/
    </script>
    <script>
    
	    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    
        function createFAQTree(data, parentElement) {
        	// 데이터 배열의 각 항목에 대해 반복
            data.forEach(item => {
            	// 새로운 div 요소 생성
                const itemElement = document.createElement('div');
                itemElement.className = 'faq-item';
                
                itemElement.innerHTML = `
                    <div class="faq-question">
                		<div class="main-text-id">
	                        <h3>${item.name}</h3>
	                        <input value="${item.id}" type="hidden">
	                        <button class="delete-btn">-</button>
	                    </div>
                        <button class="faq-toggle">▼</button>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                        	${item.content ? `<p>${item.content}</p>` : ''}
                            <div class="faq-actions">
                                <button class="add-btn">+</button>
                                <!-- <button class="edit-btn">수정</button> -->
                                <!-- <button class="delete-btn">삭제</button> -->
                            </div>
                        </div>
                        <div class="children"></div>
                    </div>
                `;
                parentElement.appendChild(itemElement); // 생성된 요소를 부모 요소에 추가
				
             	// 질문, 답변, 토글 버튼 요소 선택
                const questionElement = itemElement.querySelector('.faq-question');
                const answerElement = itemElement.querySelector('.faq-answer');
                const toggleButton = itemElement.querySelector('.faq-toggle');

                questionElement.addEventListener('click', () => {
                    const isOpen = answerElement.classList.contains('active');
                    if (isOpen) {
                        answerElement.classList.remove('active');
                        toggleButton.textContent = '▼';
                    } else {
                        answerElement.classList.add('active');
                        toggleButton.textContent = '▲';
                    }
                });
				
             	// 자식 항목을 위한 컨테이너 선택
                const childrenContainer = itemElement.querySelector('.children');
             	
             	// 자식 항목이 있으면 재귀적으로 createFAQTree 함수 호출
                if (item.children && item.children.length > 0) {
                    createFAQTree(item.children, childrenContainer);
                }
            });
        }

        function addNewFAQItem(parentElement) {
            const newItem = document.createElement('div');
            newItem.className = 'faq-item';
            newItem.innerHTML = `
                <div class="faq-question">
                    <form class="main-text-id"  action="/admin/faqs/first" method="post">
	                    <input type="hidden" name="${header}" value="${token}"/>
                        <input class="faq-input" type="text" name="name" placeholder="카테고리 입력">
                        <button class="complete-btn" id="complete-btn" type="submit">완료</button>
                    </form>
                    <button class="faq-toggle">▼</button>
                </div>
                <div class="faq-answer">
                    <div class="faq-answer-content">
                        <textarea class="faq-input" placeholder="답변 입력"></textarea>
                        <div class="faq-actions">
                            <button class="save-btn">저장</button>
                            <button class="cancel-btn">취소</button>
                        </div>
                    </div>
                </div>
            `;
            parentElement.insertBefore(newItem, parentElement.firstChild);

            const saveBtn = newItem.querySelector('.save-btn');
            const cancelBtn = newItem.querySelector('.cancel-btn');

            saveBtn.addEventListener('click', () => {
                const questionInput = newItem.querySelector('.faq-question input');
                const answerTextarea = newItem.querySelector('.faq-answer textarea');
                // 여기에 저장 로직 추가 (예: API 호출)
                console.log('저장:', questionInput.value, answerTextarea.value);
            });

            cancelBtn.addEventListener('click', () => {
                parentElement.removeChild(newItem);
            });
        }

        // FAQ 트리 생성
        const faqListElement = document.getElementById('faq-list');
        createFAQTree(faqData, faqListElement);

        // 최상위 추가 버튼과 완료, 취소 버튼
        const addBtn = document.getElementById('first-add-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // 추가 버튼 클릭 이벤트
        addBtn.addEventListener('click', () => {
            addNewFAQItem(faqListElement);
            addBtn.style.display = 'none';
            cancelBtn.style.display = 'inline-block';
        });
	
        /*
        // 완료 버튼 클릭 이벤트
        const completeBtn = document.getElementById('complete-btn');
        completeBtn.addEventListener('click', () => {
            completeBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            addBtn.style.display ='inline-block';
            // 여기에 완료 시 수행할 작업 추가 (예: 서버에 데이터 전송)
            console.log('FAQ 추가 완료');
        });
        */
        
        //취소 버튼 클릭 이벤트
        cancelBtn.addEventListener('click', () => {
        	
        	if (faqListElement.firstChild) {
                faqListElement.removeChild(faqListElement.firstChild);
            }
        	
            completeBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            addBtn.style.display ='inline-block';
        });
        
    </script>
</main>
</html>